# GCP ã¨ OCI ã‚’ã¤ãªãï¼Partner Interconnect Ã— FastConnect æ§‹æˆã‚’è§£èª¬

## ã¯ã˜ã‚ã«

ã¯ã˜ã‚ã¾ã—ã¦ï¼ [ã‚¢ãƒƒãƒ—ãƒ«ãƒ¯ãƒ¼ãƒ«ãƒ‰](https://appleworld.co.jp)ã§ã€ã‚¤ãƒ³ãƒ•ãƒ©ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢æ‹…å½“ã—ã¦ã„ã‚‹å¤§ä¹…ä¿ã§ã™ã€‚

ã‚¢ãƒƒãƒ—ãƒ«ãƒ¯ãƒ¼ãƒ«ãƒ‰ã§ã¯ã€B2Bå‘ã‘ãƒ›ãƒ†ãƒ«äºˆç´„ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã« Oracle Cloud Infrastructureï¼ˆOCIï¼‰ ã® Oracle DB ã¨ã€WEBã‚µãƒ¼ãƒã« Google Cloud Platform(GCP) ã‚’ä½¿ç”¨ã—ã¦ã‚‹ã¨ã„ã†ã€ã¡ã‚‡ã£ã¨ç‰¹æ®Šãªæ§‹æˆã ã£ãŸã‚Šã—ã¾ã™ã€‚

ãã‚“ãªãƒ‹ãƒƒãƒãªæ§‹æˆã§ã™ãŒã€  
- ã€Œãƒãƒ«ãƒã‚¯ãƒ©ã‚¦ãƒ‰ã‚„ã£ã¦ã¿ãŸã„ã‘ã©ã€ã‚¯ãƒ©ã‚¦ãƒ‰é–“ã®æ¥ç¶šã£ã¦ã©ã†ã‚„ã‚‹ã®ï¼Ÿã€
- ã€ŒGCP ã¨ OCI ä¸¡æ–¹ä½¿ã£ã¦ã‚‹ã‘ã©ã€ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§ç¹‹ã’ãŸã„...ã€
- ã€ŒTerraform ã§ã‚¯ãƒ©ã‚¦ãƒ‰é–“æ¥ç¶šã‚’è©¦ã—ãŸã„æ–¹ã€

ã“ã‚“ãªæ‚©ã¿ã‚’æŒã£ã¦ã„ã‚‹æ–¹ã¸
**GCP** ã¨ **OCI** ã‚’ã€ä»®æƒ³å°‚ç”¨ç·šã§æ¥ç¶šã™ã‚‹ã¿ãŸã„ãªéœ€è¦ã¯å°‘ãªã„ã§ã™ãŒã€Terraform ã‚’ä½¿ãˆã°æ„å¤–ã¨ç°¡å˜ã«ã‚¯ãƒ©ã‚¦ãƒ‰é–“æ¥ç¶šãŒã§ãã¡ã‚ƒã†ã‚“ã§ã™ï¼

ãã“ã§ Terraform ã‚’ä½¿ã£ã¦ã€**GCP Cloud Interconnectï¼ˆPartner Interconnectï¼‰** ã¨ **OCI FastConnect** ã‚’çµ„ã¿åˆã‚ã›ã¦ã€å®Ÿéš›ã«å‹•ã Terraform ã‚³ãƒ¼ãƒ‰ã‚’äº¤ãˆãªãŒã‚‰ã€GCP ã¨ OCI ã‚’æ¥ç¶šã™ã‚‹æ–¹æ³•ã‚’è§£èª¬ã—ã¦ã„ãã¾ã™ã€‚

### å‰æã¨ãªã‚‹çŸ¥è­˜

ã“ã®è¨˜äº‹ã‚’èª­ã‚€ã«ã‚ãŸã£ã¦ã€ä»¥ä¸‹ã®çŸ¥è­˜ãŒã‚ã‚‹ã¨ã‚¹ãƒ ãƒ¼ã‚ºã«ç†è§£ã§ãã‚‹ã¨æ€ã„ã¾ã™ï¼

- **Terraform ã®åŸºæœ¬æ“ä½œ**ï¼š`terraform apply` ãŒä½¿ãˆã‚‹
- **GCP ã®åŸºç¤çŸ¥è­˜ã¨ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**ï¼šVPCã€ã‚µãƒ–ãƒãƒƒãƒˆã€ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ãƒ«ãƒ¼ãƒ«ã‚ãŸã‚ŠãŒã‚ã‹ã‚Šã€ç·¨é›†ã™ã‚‹æ¨©é™ãŒå¿…è¦
- **OCI ã®åŸºç¤çŸ¥è­˜ã¨ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**ï¼šVCNã€ã‚µãƒ–ãƒãƒƒãƒˆã€ã‚³ãƒ³ãƒ‘ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆã‚ãŸã‚ŠãŒã‚ã‹ã‚Šã€ç·¨é›†ã™ã‚‹æ¨©é™ãŒå¿…è¦
- **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®åŸºç¤**ï¼šCIDR è¡¨è¨˜ã€ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®åŸºæœ¬çš„ãªæ¦‚å¿µ
- **BGP ã®æ¦‚è¦**ï¼šã€Œãƒ«ãƒ¼ã‚¿ãƒ¼ãŒçµŒè·¯æƒ…å ±ã‚’äº¤æ›ã™ã‚‹ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã€ãã‚‰ã„ã®ç†è§£ã§OK

å…¨éƒ¨å®Œç’§ã«ã‚ã‹ã£ã¦ãªãã¦ã‚‚å¤§ä¸ˆå¤«ï¼è¨˜äº‹ã®ä¸­ã§ã‚‚èª¬æ˜ã—ã¦ã„ãã®ã§ã€æ°—è»½ã«èª­ã¿é€²ã‚ã¦ãã ã•ã„ã­ã€‚

### è§£èª¬ã¯é£›ã°ã—ã¦ ã‚µã‚¯ãƒƒã¨ Terraform ã§å‹•ä½œã•ã›ãŸã„æ–¹å‘ã‘

ã“ã¡ã‚‰ã® github ãƒªãƒã‚¸ãƒˆãƒªã«ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¼‰ã›ã¦ã¾ã™ã®ã§ã€

```bash
git clone git@github.com:take-ookubo/terraform_for_gcp_oci_interconnect.git
cd terraform_for_gcp_oci_interconnect
# variables.tf ã®å€¤ã‚’å„è‡ªã®ç’°å¢ƒã«ã‚ã‚ã›ã¦å¤‰æ›´ã™ã‚‹
terraform init
terraform plan
terraform apply
```

#### GCP VLAN ãƒšã‚¢ãƒªãƒ³ã‚°ã‚­ãƒ¼ã‚’å–å¾—ã—ã¦ OCI å´ã«è¨­å®šã™ã‚‹

TODO: ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£ã§èª¬æ˜ã™ã‚‹

### ä»Šå›ã®æ§‹æˆã®ãƒã‚¤ãƒ³ãƒˆ

ä»Šå›ä½œã‚‹æ§‹æˆã®ãƒã‚¤ãƒ³ãƒˆã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™ï¼š

- **Terraform** ã§å…¨éƒ¨ã‚³ãƒ¼ãƒ‰åŒ–ï¼ˆä½•åº¦ã§ã‚‚å†ç¾ã§ãã‚‹ï¼ï¼‰
- **BGP** ã§å‹•çš„ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆçµŒè·¯ã‚’è‡ªå‹•ã§äº¤æ›ã—ã¦ãã‚Œã‚‹ï¼‰

ãã‚Œã§ã¯ã€ã•ã£ããè¦‹ã¦ã„ãã¾ã—ã‚‡ã†ï¼

## å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

ã¾ãšã¯ã€å…¨ä½“åƒã‚’å›³ã§è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

TODO: draw.io ã§å›³ã‚’ç”¨æ„

## æ§‹ç¯‰ã®æµã‚Œ

å®Ÿéš›ã«æ§‹ç¯‰ã™ã‚‹å ´åˆã®å¤§ã¾ã‹ãªæµã‚Œã§ã™ã€‚

### Step 1: GCP å´ã®æº–å‚™
1. VPC ã‚’ä½œæˆ
2. ã‚µãƒ–ãƒãƒƒãƒˆã‚’ä½œæˆ
3. Cloud Router ã‚’ä½œæˆ
4. VLAN Attachment ã‚’ä½œæˆ â†’ **ãƒšã‚¢ãƒªãƒ³ã‚°ã‚­ãƒ¼ã‚’å–å¾—**

### Step 2: OCI å´ã®æº–å‚™
1. VCN ã‚’ä½œæˆ
2. ã‚µãƒ–ãƒãƒƒãƒˆã‚’ä½œæˆ
3. DRG ã‚’ä½œæˆ
4. DRG ã‚’ VCN ã«ã‚¢ã‚¿ãƒƒãƒ
5. Virtual Circuit ã‚’ä½œæˆ

### Step 3: ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼äº‹æ¥­è€…ã§ã®ä½œæ¥­
1. ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®ãƒãƒ¼ã‚¿ãƒ«ã«ãƒ­ã‚°ã‚¤ãƒ³
2. GCP ã®ãƒšã‚¢ãƒªãƒ³ã‚°ã‚­ãƒ¼ã‚’å…¥åŠ›
3. OCI ã® Virtual Circuit ã¨æ¥ç¶š
4. æ¥ç¶šã‚’æœ‰åŠ¹åŒ–

### Step 4: æ¥ç¶šç¢ºèª
1. GCP å´ã§ VLAN Attachment ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª
2. OCI å´ã§ Virtual Circuit ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª
3. ç–é€šãƒ†ã‚¹ãƒˆï¼ˆping ãªã©ï¼‰

---

## å„ç’°å¢ƒã”ã¨ã®å¤‰æ•°ã®æ›´æ–°

TODO: variables.tf æ›´æ–°ã®èª¬æ˜

## å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’è©³ã—ãè§£èª¬

### GCP å´ã§è‚ã«ãªã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

#### 1. Cloud Router

Cloud Router ã¯ã€**ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æƒ…å ±ã‚’è‡ªå‹•çš„ã«ã‚„ã‚Šå–ã‚Šã™ã‚‹** ãŸã‚ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã™ã€‚

BGPï¼ˆBorder Gateway Protocolï¼‰ã¨ã„ã†ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ä½¿ã£ã¦ã€ã€Œã“ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¸ã®é€šä¿¡ã¯ã€ã“ã£ã¡ã«é€ã£ã¦ã­ã€ã¨ã„ã†æƒ…å ±ã‚’è‡ªå‹•çš„ã«äº¤æ›ã—ã¾ã™ã€‚

```hcl
resource "google_compute_router" "router" {
  name    = "gcp-oci-vpc-router"
  region  = "asia-northeast1"
  network = google_compute_network.vpc.id

  bgp {
    asn = 16550  # GCP ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ ASN
  }
}
```

> ğŸ’¡ ASNï¼ˆAutonomous System Numberï¼‰ã¯ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’è­˜åˆ¥ã™ã‚‹ãŸã‚ã®ç•ªå·ã§ã™ã€‚GCP ã¯ 16550 ã‚’ä½¿ã„ã¾ã™ã€‚

#### 2. VLAN Attachmentï¼ˆPartner Interconnectï¼‰

VLAN Attachment ã¯ã€**ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼äº‹æ¥­è€…ã¨ã®æ¥ç¶šãƒã‚¤ãƒ³ãƒˆ** ã§ã™ã€‚

ã“ã‚Œã‚’ä½œæˆã™ã‚‹ã¨ã€Œãƒšã‚¢ãƒªãƒ³ã‚°ã‚­ãƒ¼ã€ãŒç™ºè¡Œã•ã‚Œã¾ã™ã€‚ã“ã®ã‚­ãƒ¼ã‚’ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼äº‹æ¥­è€…ï¼ˆEquinix ã‚„ Megaport ãªã©ï¼‰ã«ä¼ãˆã‚‹ã“ã¨ã§ã€æ¥ç¶šãŒç¢ºç«‹ã•ã‚Œã¾ã™ã€‚

```hcl
resource "google_compute_interconnect_attachment" "partner_interconnect" {
  name   = "gcp-oci-vpc-partner-interconnect"
  region = "asia-northeast1"
  router = google_compute_router.router.id
  type   = "PARTNER"
}
```

---

### OCI å´ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

#### 1. DRGï¼ˆDynamic Routing Gatewayï¼‰

DRG ã¯ã€**VCN ã®å¤–éƒ¨ã¨é€šä¿¡ã™ã‚‹ãŸã‚ã®ç„é–¢å£** ã§ã™ã€‚

VCN ã‹ã‚‰å¤–éƒ¨ï¼ˆä»Šå›ã¯ GCPï¼‰ã¸å‡ºã¦ã„ãé€šä¿¡ã¯ã€ã™ã¹ã¦ã“ã® DRG ã‚’çµŒç”±ã—ã¾ã™ã€‚GCP ã® Cloud Router ã«ç›¸å½“ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã™ã€‚

```hcl
resource "oci_core_drg" "drg" {
  compartment_id = var.compartment_id
  display_name   = "oci-gcp-vcn-drg"
}
```

DRG ã‚’ä½œæˆã—ãŸã‚‰ã€VCN ã«ã‚¢ã‚¿ãƒƒãƒï¼ˆæ¥ç¶šï¼‰ã—ã¾ã™ã€‚

```hcl
resource "oci_core_drg_attachment" "drg_attachment" {
  drg_id = oci_core_drg.drg.id
  network_details {
    id   = oci_core_vcn.vcn.id
    type = "VCN"
  }
}
```

#### 2. Virtual Circuitï¼ˆFastConnectï¼‰

Virtual Circuit ã¯ã€**FastConnect ã®è«–ç†çš„ãªæ¥ç¶š** ã§ã™ã€‚

GCP ã® VLAN Attachment ã«ç›¸å½“ã—ã¾ã™ã€‚ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼äº‹æ¥­è€…ã‚’çµŒç”±ã—ã¦ã€GCP ã¨æ¥ç¶šã™ã‚‹ãŸã‚ã®è¨­å®šã§ã™ã€‚

```hcl
resource "oci_core_virtual_circuit" "virtual_circuit" {
  compartment_id       = var.compartment_id
  display_name         = "oci-gcp-vcn-virtual-circuit"
  type                 = "PRIVATE"
  bandwidth_shape_name = "1 Gbps"
  gateway_id           = oci_core_drg.drg.id
}
```

---

### ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼

GCP ã¨ OCI ã‚’ç›´æ¥ã¤ãªãã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚é–“ã« **ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼äº‹æ¥­è€…** ãŒå…¥ã‚Šã¾ã™ã€‚

ä¸»ãªãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼äº‹æ¥­è€…ï¼š
- **Equinix Fabric** - ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å±•é–‹ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚»ãƒ³ã‚¿ãƒ¼äº‹æ¥­è€…
- **Megaport** - ã‚¯ãƒ©ã‚¦ãƒ‰æ¥ç¶šã«ç‰¹åŒ–ã—ãŸäº‹æ¥­è€…
- **Console Connectï¼ˆPCCWï¼‰** - ã‚¢ã‚¸ã‚¢ã«å¼·ã„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯äº‹æ¥­è€…

ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼äº‹æ¥­è€…ã¯ã€è‡ªç¤¾ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ã£ã¦ GCP ã¨ OCI ã®é–“ã‚’ã¤ãªã„ã§ãã‚Œã¾ã™ã€‚

---

## é€šä¿¡ã®æµã‚Œ

GCP ã® VM ã‹ã‚‰ OCI ã® VM ã¸é€šä¿¡ã™ã‚‹å ´åˆã€ä»¥ä¸‹ã®æµã‚Œã«ãªã‚Šã¾ã™ã€‚

```
GCP VM (10.0.0.10)
    â†“
GCP Subnet
    â†“
Cloud Routerï¼ˆBGP ã§ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼‰
    â†“
VLAN Attachment
    â†“
Partner Provider ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯
    â†“
Virtual Circuitï¼ˆFastConnectï¼‰
    â†“
DRGï¼ˆBGP ã§ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼‰
    â†“
OCI Subnet
    â†“
OCI VM (192.168.0.10)
```

BGP ã«ã‚ˆã£ã¦ã€ã€Œ10.0.0.0/24 ã¯ GCP ã«ã‚ã‚‹ã€ã€Œ192.168.0.0/24 ã¯ OCI ã«ã‚ã‚‹ã€ã¨ã„ã†æƒ…å ±ãŒè‡ªå‹•çš„ã«äº¤æ›ã•ã‚Œã‚‹ãŸã‚ã€æ‰‹å‹•ã§ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¨­å®šã™ã‚‹å¿…è¦ã¯ã»ã¨ã‚“ã©ã‚ã‚Šã¾ã›ã‚“ã€‚

---

## âš ï¸ é‡è¦ï¼šæœ€å¾Œã«æœ¬æ§‹æˆã¯å†—é•·æ§‹æˆã§ã¯ã‚ã‚Šã¾ã›ã‚“

**æœ¬è¨˜äº‹ã§ç´¹ä»‹ã™ã‚‹æ§‹æˆã¯ã€æ¤œè¨¼ãƒ»å­¦ç¿’ç›®çš„ã®ã‚·ãƒ³ã‚°ãƒ«æ§‹æˆã§ã™ã€‚**

å°‚ç”¨ç·šã‚„ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼è¨­å‚™ã«éšœå®³ãŒç™ºç”Ÿã—ãŸå ´åˆã€æœ¬æ§‹æˆã§ã¯ **é€šä¿¡ãŒå®Œå…¨ã«åœæ­¢** ã—ã¾ã™ã€‚
æœ¬ç•ªç’°å¢ƒã§ã¯å¿…ãšå†—é•·æ§‹æˆã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚

---

## å‚è€ƒãƒªãƒ³ã‚¯

- [GCP Partner Interconnect ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://cloud.google.com/network-connectivity/docs/interconnect/concepts/partner-overview)
- [OCI FastConnect ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.oracle.com/en-us/iaas/Content/Network/Concepts/fastconnect.htm)
- [Terraform Google Provider](https://registry.terraform.io/providers/hashicorp/google/latest/docs)
- [Terraform OCI Provider](https://registry.terraform.io/providers/oracle/oci/latest/docs)

TODO ã‚‚ã£ã¨æŸ”ã‚‰ã‹ã„è¨˜äº‹æ¢ã™